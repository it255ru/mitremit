name: Docker Security Scan - Alpine

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

# –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–ø—É—Å–∫–∏ –ø—Ä–∏ –Ω–æ–≤–æ–º push
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

# Pinned versions –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
env:
  HADOLINT_VERSION: "2.12.0"
  GRYPE_VERSION: "0.84.0"
  SYFT_VERSION: "1.18.1"
  TRIVY_VERSION: "0.58.0"
  DIVE_VERSION: "0.12.0"

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write

jobs:
  # ========== MAIN SECURITY SCAN ==========
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      build_success: ${{ steps.build.outputs.build_success }}
      critical_count: ${{ steps.analysis.outputs.critical_count }}
      sbom_real_vuln_count: ${{ steps.sbom_scan.outputs.sbom_real_vuln_count }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ========== CACHE SECURITY TOOLS ==========
    - name: Cache security tools
      uses: actions/cache@v4
      id: cache-tools
      with:
        path: |
          /usr/local/bin/hadolint
          /usr/local/bin/syft
          /usr/local/bin/grype
          /usr/local/bin/trivy
          /usr/local/bin/dive
        key: security-tools-${{ runner.os }}-hadolint${{ env.HADOLINT_VERSION }}-grype${{ env.GRYPE_VERSION }}-syft${{ env.SYFT_VERSION }}-trivy${{ env.TRIVY_VERSION }}-dive${{ env.DIVE_VERSION }}

    # ========== INSTALL TOOLS (if not cached) ==========
    - name: Install Hadolint
      if: steps.cache-tools.outputs.cache-hit != 'true'
      run: |
        echo "üì• Installing Hadolint v${HADOLINT_VERSION}..."
        curl -sL -o hadolint "https://github.com/hadolint/hadolint/releases/download/v${HADOLINT_VERSION}/hadolint-Linux-x86_64"
        chmod +x hadolint
        sudo mv hadolint /usr/local/bin/
        hadolint --version
        echo "‚úÖ Hadolint installed successfully"

    - name: Install Syft
      if: steps.cache-tools.outputs.cache-hit != 'true'
      run: |
        echo "üì• Installing Syft v${SYFT_VERSION}..."
        curl -sSfL "https://github.com/anchore/syft/releases/download/v${SYFT_VERSION}/syft_${SYFT_VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin syft
        syft version
        echo "‚úÖ Syft installed successfully"

    - name: Install Grype
      if: steps.cache-tools.outputs.cache-hit != 'true'
      run: |
        echo "üì• Installing Grype v${GRYPE_VERSION}..."
        curl -sSfL "https://github.com/anchore/grype/releases/download/v${GRYPE_VERSION}/grype_${GRYPE_VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin grype
        grype version
        echo "‚úÖ Grype installed successfully"

    - name: Install Trivy
      if: steps.cache-tools.outputs.cache-hit != 'true'
      run: |
        echo "üì• Installing Trivy v${TRIVY_VERSION}..."
        curl -sSfL "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz" | tar xz -C /usr/local/bin trivy
        trivy version
        echo "‚úÖ Trivy installed successfully"

    - name: Install Dive
      if: steps.cache-tools.outputs.cache-hit != 'true'
      run: |
        echo "üì• Installing Dive v${DIVE_VERSION}..."
        curl -sSfL "https://github.com/wagoodman/dive/releases/download/v${DIVE_VERSION}/dive_${DIVE_VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin dive
        dive version
        echo "‚úÖ Dive installed successfully"

    - name: Install jq
      run: |
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi

    # ========== CREATE IGNORE CONFIGS ==========
    - name: Create scanner ignore configs
      run: |
        echo "üìù Creating scanner ignore configurations..."
        
        # Grype config (YAML - –≤–∞–∂–Ω–æ –±–µ–∑ –æ—Ç—Å—Ç—É–ø–æ–≤ –≤ –Ω–∞—á–∞–ª–µ!)
        cat > .grype.yaml << 'EOF'
ignore:
  - vulnerability: CVE-2025-60876
    reason: "busybox wget not used - Go app uses native net/http"
  - vulnerability: CVE-2025-46394
    reason: "busybox tar escape sequences - not exploitable in this context"
EOF
        
        # Trivy ignorefile (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ CVE)
        cat > .trivyignore << 'EOF'
# BusyBox vulnerabilities - not applicable for Go binary
CVE-2025-60876
CVE-2025-46394
EOF
        
        echo "‚úÖ Ignore configs created"
        echo "=== .grype.yaml ==="
        cat .grype.yaml
        echo ""
        echo "=== .trivyignore ==="
        cat .trivyignore

    # ========== LINTING ==========
    - name: Run Hadolint
      id: hadolint
      run: |
        echo "üîç Checking for Dockerfile..."
        
        if [ ! -f "Dockerfile" ]; then
          echo "‚ùå Dockerfile not found for Hadolint"
          echo '[]' > hadolint-results.json
          exit 0
        fi
        
        echo "‚úÖ Running Hadolint on Dockerfile"
        hadolint --format json Dockerfile > hadolint-results.json || true

        if [ -s hadolint-results.json ]; then
          HADOLINT_ISSUES=$(jq '. | length' hadolint-results.json 2>/dev/null || echo "0")
          echo "üìä Hadolint found $HADOLINT_ISSUES issues"
        else
          echo "‚úÖ Hadolint completed - no issues found"
        fi
      
    - name: Check for .dockerignore
      id: dockerignore_check
      run: |
        if [ -f ".dockerignore" ]; then
          echo "dockerignore_exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ .dockerignore file found"
        else
          echo "dockerignore_exists=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No .dockerignore file found"
        fi

    # ========== BUILD STAGE ==========
    - name: Build Docker image
      id: build
      continue-on-error: true
      run: |
        echo "üèóÔ∏è Building Docker image..."
        
        if [ ! -f "Dockerfile" ]; then
          echo "‚ùå ERROR: Dockerfile not found in current directory"
          echo "Current directory content:"
          ls -la
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "‚úÖ Dockerfile found. Content preview:"
        head -5 Dockerfile
        
        set +e
        echo "üî® Starting Docker build..."
        docker build --progress=plain -t alpine-secure:latest . 2>&1 | tee build-output.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Docker build successful"
          echo "build_success=true" >> $GITHUB_OUTPUT
          
          echo "üíæ Saving Docker image to tar.gz..."
          docker save alpine-secure:latest | gzip > alpine-secure-image.tar.gz
          ls -lh alpine-secure-image.tar.gz
          
          echo "üß™ Testing Alpine image basics..."
          docker run --rm alpine-secure:latest cat /etc/alpine-release 2>/dev/null || echo "Release check failed (might be scratch image)"
          docker run --rm alpine-secure:latest whoami 2>/dev/null || echo "User check failed (might be scratch image)"
        else
          echo "‚ùå Docker build failed with exit code: $BUILD_EXIT_CODE"
          echo "build_success=false" >> $GITHUB_OUTPUT
          echo "=== LAST 20 LINES OF BUILD ERRORS ==="
          tail -20 build-output.log || echo "No build output available"
        fi

    # ========== SBOM GENERATION ==========
    - name: Generate SBOM
      if: steps.build.outputs.build_success == 'true'
      id: sbom_generation
      run: |
        echo "üìã Generating SBOM for Alpine image..."
        
        syft alpine-secure:latest -o cyclonedx-json > sbom.cyclonedx.json
        syft alpine-secure:latest -o spdx-json > sbom.spdx.json
        syft alpine-secure:latest -o syft-json > sbom.syft.json
        
        COMPONENT_COUNT=$(jq '.components | length' sbom.cyclonedx.json 2>/dev/null || echo "0")
        ALPINE_COMPONENTS=$(jq '[.components[]? | select(.purl != null) | select(.purl | type == "string") | select(.purl | startswith("pkg:apk/alpine"))] | length' sbom.cyclonedx.json 2>/dev/null || echo "0")
        ALPINE_VERSION=$(docker run --rm --entrypoint cat alpine-secure:latest /etc/alpine-release 2>/dev/null | tr -d '\r' || echo "scratch/unknown")
        
        echo "component_count=$COMPONENT_COUNT" >> $GITHUB_OUTPUT
        echo "alpine_components=$ALPINE_COMPONENTS" >> $GITHUB_OUTPUT
        echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT
        
        echo "‚úÖ SBOM generated with $COMPONENT_COUNT components ($ALPINE_COMPONENTS Alpine packages)"
        echo "üì¶ Alpine version: $ALPINE_VERSION"

    # ========== VULNERABILITY SCANNING - GRYPE ==========
    - name: Scan SBOM with Grype
      if: steps.build.outputs.build_success == 'true'
      id: sbom_scan
      run: |
        echo "üîç Scanning SBOM with Grype..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤–∞–ª–∏–¥–µ–Ω
        echo "üìã Using Grype config:"
        cat .grype.yaml
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        grype sbom:sbom.cyclonedx.json --config .grype.yaml -o json > sbom-scan-all-severities.json 2>&1 || true
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if [ -f sbom-scan-all-severities.json ] && jq -e . sbom-scan-all-severities.json > /dev/null 2>&1; then
          echo "‚úÖ Scan completed successfully"
          
          # –ü–æ–¥—Å—á—ë—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
          SBOM_VULN_COUNT=$(jq '.matches // [] | length' sbom-scan-all-severities.json)
          SBOM_CRITICAL_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "Critical")] | length' sbom-scan-all-severities.json)
          SBOM_HIGH_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "High")] | length' sbom-scan-all-severities.json)
          SBOM_MEDIUM_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "Medium")] | length' sbom-scan-all-severities.json)
          SBOM_LOW_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "Low")] | length' sbom-scan-all-severities.json)
          SBOM_UNKNOWN_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "Unknown" or .vulnerability.severity == null)] | length' sbom-scan-all-severities.json)

          SBOM_REAL_VULN_COUNT=$((SBOM_CRITICAL_COUNT + SBOM_HIGH_COUNT + SBOM_MEDIUM_COUNT + SBOM_LOW_COUNT + SBOM_UNKNOWN_COUNT))
          
          echo "sbom_vuln_count=$SBOM_VULN_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_real_vuln_count=$SBOM_REAL_VULN_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_critical_count=$SBOM_CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_high_count=$SBOM_HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_medium_count=$SBOM_MEDIUM_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_low_count=$SBOM_LOW_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_unknown_count=$SBOM_UNKNOWN_COUNT" >> $GITHUB_OUTPUT
          
          echo "üìä Grype found: $SBOM_VULN_COUNT total matches"
          echo "üìä Real vulnerabilities: $SBOM_REAL_VULN_COUNT"
          echo "üìä Breakdown - Critical: $SBOM_CRITICAL_COUNT, High: $SBOM_HIGH_COUNT, Medium: $SBOM_MEDIUM_COUNT, Low: $SBOM_LOW_COUNT, Unknown: $SBOM_UNKNOWN_COUNT"
          
          # –°–æ–∑–¥–∞—ë–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
          echo "## Grype Vulnerability Report" > grype-detailed-report.md
          echo "" >> grype-detailed-report.md
          echo "| Severity | CVE ID | Package | Version |" >> grype-detailed-report.md
          echo "|----------|--------|---------|---------|" >> grype-detailed-report.md
          jq -r '.matches[]? | "| \(.vulnerability.severity // "Unknown") | \(.vulnerability.id) | \(.artifact.name) | \(.artifact.version) |"' sbom-scan-all-severities.json >> grype-detailed-report.md 2>/dev/null || true
          
        else
          echo "‚ö†Ô∏è Grype scan produced no valid output"
          for var in sbom_vuln_count sbom_real_vuln_count sbom_critical_count sbom_high_count sbom_medium_count sbom_low_count sbom_unknown_count; do
            echo "${var}=0" >> $GITHUB_OUTPUT
          done
        fi

    # ========== VULNERABILITY SCANNING - TRIVY ==========
    - name: Run Trivy vulnerability scan
      if: steps.build.outputs.build_success == 'true'
      id: trivy_scan
      run: |
        echo "üîç Running Trivy scan..."
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º .trivyignore –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è CVE
        trivy image \
          --ignorefile .trivyignore \
          --format json \
          --output trivy-results-all-severities.json \
          alpine-secure:latest
        
        trivy image \
          --ignorefile .trivyignore \
          --format table \
          --output trivy-report.txt \
          alpine-secure:latest

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã Trivy (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π jq)
        if [ -f "trivy-results-all-severities.json" ] && jq -e . trivy-results-all-severities.json > /dev/null 2>&1; then
          TRIVY_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-results-all-severities.json)
          TRIVY_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-results-all-severities.json)
          TRIVY_MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' trivy-results-all-severities.json)
          TRIVY_LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "LOW")] | length' trivy-results-all-severities.json)
          TRIVY_UNKNOWN=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "UNKNOWN" or .Severity == null)] | length' trivy-results-all-severities.json)
          TRIVY_TOTAL=$((TRIVY_CRITICAL + TRIVY_HIGH + TRIVY_MEDIUM + TRIVY_LOW + TRIVY_UNKNOWN))
          
          echo "trivy_critical_count=$TRIVY_CRITICAL" >> $GITHUB_OUTPUT
          echo "trivy_high_count=$TRIVY_HIGH" >> $GITHUB_OUTPUT
          echo "trivy_medium_count=$TRIVY_MEDIUM" >> $GITHUB_OUTPUT
          echo "trivy_low_count=$TRIVY_LOW" >> $GITHUB_OUTPUT
          echo "trivy_unknown_count=$TRIVY_UNKNOWN" >> $GITHUB_OUTPUT
          echo "trivy_total_count=$TRIVY_TOTAL" >> $GITHUB_OUTPUT
          
          echo "üìä Trivy found: $TRIVY_TOTAL vulnerabilities"
          echo "üìä Breakdown - CRITICAL: $TRIVY_CRITICAL, HIGH: $TRIVY_HIGH, MEDIUM: $TRIVY_MEDIUM, LOW: $TRIVY_LOW, UNKNOWN: $TRIVY_UNKNOWN"
        else
          for var in trivy_critical_count trivy_high_count trivy_medium_count trivy_low_count trivy_unknown_count trivy_total_count; do
            echo "${var}=0" >> $GITHUB_OUTPUT
          done
          echo "üìä Trivy scan completed - no vulnerabilities found"
        fi

    # ========== DOCKER IMAGE ANALYSIS ==========
    - name: Analyze Docker layers
      if: steps.build.outputs.build_success == 'true'
      run: |
        echo "üîç Analyzing Docker image layers..."
        
        # Docker inspect
        docker inspect alpine-secure:latest > docker-inspect.json
        
        # Docker history
        docker history --no-trunc alpine-secure:latest > docker-layers.txt
        
        # Dive analysis (CI mode)
        CI=true dive alpine-secure:latest --json > dive-analysis.json 2>/dev/null || echo '{"error": "dive analysis failed"}' > dive-analysis.json
        
        # –°–æ–∑–¥–∞—ë–º —á–∏—Ç–∞–µ–º—ã–π –æ—Ç—á—ë—Ç –ø–æ —Å–ª–æ—è–º
        echo "# Docker Image Layers Analysis" > docker-layers-detailed.md
        echo "" >> docker-layers-detailed.md
        echo "## Layer History" >> docker-layers-detailed.md
        echo '```' >> docker-layers-detailed.md
        docker history alpine-secure:latest >> docker-layers-detailed.md
        echo '```' >> docker-layers-detailed.md
        
        echo "‚úÖ Docker layer analysis completed"

    # ========== PACKAGE TABLE ==========
    - name: Generate package table with vulnerabilities
      if: steps.build.outputs.build_success == 'true'
      run: |
        echo "üìä Generating package table..."
        
        if [ -f "sbom.cyclonedx.json" ]; then
          echo "## üì¶ Packages in Image" > package-table.md
          echo "" >> package-table.md
          echo "| Package | Version | Type | Vulnerabilities |" >> package-table.md
          echo "|---------|---------|------|-----------------|" >> package-table.md
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º jq –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
          jq -r '
            .components[]? | 
            select(.type == "library" or .type == "application") | 
            select(.name != "command-line-arguments") |
            "| \(.name | split("/") | last) | \(.version // "N/A") | \(.type) | - |"
          ' sbom.cyclonedx.json >> package-table.md 2>/dev/null || true
          
          echo "" >> package-table.md
          echo "‚úÖ Package table generated"
        else
          echo "# üì¶ Packages" > package-table.md
          echo "No package information available" >> package-table.md
        fi

    # ========== DOCKERFILE ANALYSIS ==========
    - name: Run Dockerfile analysis
      if: steps.build.outputs.build_success == 'true'
      id: analysis
      env:
        BUILD_SUCCESS: ${{ steps.build.outputs.build_success }}
        DOCKERIGNORE_EXISTS: ${{ steps.dockerignore_check.outputs.dockerignore_exists }}
        SBOM_COMPONENT_COUNT: ${{ steps.sbom_generation.outputs.component_count }}
        SBOM_ALPINE_COMPONENTS: ${{ steps.sbom_generation.outputs.alpine_components }}
        SBOM_REAL_VULN_COUNT: ${{ steps.sbom_scan.outputs.sbom_real_vuln_count }}
        SBOM_CRITICAL_COUNT: ${{ steps.sbom_scan.outputs.sbom_critical_count }}
        SBOM_HIGH_COUNT: ${{ steps.sbom_scan.outputs.sbom_high_count }}
        SBOM_MEDIUM_COUNT: ${{ steps.sbom_scan.outputs.sbom_medium_count }}
        SBOM_LOW_COUNT: ${{ steps.sbom_scan.outputs.sbom_low_count }}
        ALPINE_VERSION: ${{ steps.sbom_generation.outputs.alpine_version }}
      run: |
        set +e
        
        echo "## üìã Alpine Dockerfile Security Analysis" > analysis-results.md
        echo "" >> analysis-results.md
        echo "**Scan date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> analysis-results.md
        echo "**Commit:** ${{ github.sha }}" >> analysis-results.md
        echo "**Branch:** ${{ github.ref_name }}" >> analysis-results.md
        echo "**Alpine version:** ${ALPINE_VERSION:-unknown}" >> analysis-results.md
        echo "" >> analysis-results.md
        
        if [ ! -f "Dockerfile" ]; then
          echo "‚ùå **ERROR**: Dockerfile not found" >> analysis-results.md
          echo "issue_count=1" >> $GITHUB_OUTPUT
          echo "critical_count=1" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        DOCKERFILE_ISSUE_COUNT=0
        CRITICAL_COUNT=0
        HIGH_COUNT=0
        MEDIUM_COUNT=0
        LOW_COUNT=0
        
        echo "### üîç Dockerfile Configuration Checks" >> analysis-results.md
        echo "" >> analysis-results.md
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        LAST_USER=$(grep "^USER " Dockerfile | tail -1 || echo "")
        if [[ -n "$LAST_USER" && "$LAST_USER" != "USER root" && "$LAST_USER" != "USER 0" ]]; then
          echo "‚úÖ Non-root user configured: \`$LAST_USER\`" >> analysis-results.md
        else
          echo "‚ö†Ô∏è **WARNING**: No non-root user detected" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          HIGH_COUNT=$((HIGH_COUNT + 1))
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ ADD vs COPY
        if grep -q "^ADD " Dockerfile 2>/dev/null; then
          echo "‚ö†Ô∏è **WARNING**: Using ADD instead of COPY" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          MEDIUM_COUNT=$((MEDIUM_COUNT + 1))
        else
          echo "‚úÖ Using COPY instead of ADD" >> analysis-results.md
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ pinned base image
        BASE_IMAGE=$(grep "^FROM " Dockerfile | head -1)
        if echo "$BASE_IMAGE" | grep -qE ":(latest|$)" 2>/dev/null; then
          echo "‚ö†Ô∏è **WARNING**: Base image without specific version: \`$BASE_IMAGE\`" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          MEDIUM_COUNT=$((MEDIUM_COUNT + 1))
        else
          echo "‚úÖ Base image with version: \`$BASE_IMAGE\`" >> analysis-results.md
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ curl | bash
        if grep -qE "(curl|wget).*\|.*(bash|sh)" Dockerfile 2>/dev/null; then
          echo "üö® **CRITICAL**: Dangerous pattern 'curl/wget | bash' detected" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
        else
          echo "‚úÖ No dangerous 'curl/wget | bash' patterns" >> analysis-results.md
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 777 permissions
        if grep -qE "chmod.*777|chmod 777" Dockerfile 2>/dev/null; then
          echo "üö® **CRITICAL**: Using 777 permissions" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
        else
          echo "‚úÖ No dangerous 777 permissions" >> analysis-results.md
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ .dockerignore
        if [ "$DOCKERIGNORE_EXISTS" = "false" ]; then
          echo "‚ö†Ô∏è **INFO**: No .dockerignore file found" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          LOW_COUNT=$((LOW_COUNT + 1))
        else
          echo "‚úÖ .dockerignore file present" >> analysis-results.md
        fi
        
        # Hadolint results
        echo "" >> analysis-results.md
        echo "### üìù Hadolint Results" >> analysis-results.md
        if [ -f hadolint-results.json ]; then
          HADOLINT_COUNT=$(jq '. | length' hadolint-results.json 2>/dev/null || echo "0")
          if [ "$HADOLINT_COUNT" -gt 0 ]; then
            echo "Found $HADOLINT_COUNT issues:" >> analysis-results.md
            echo "" >> analysis-results.md
            jq -r '.[] | "- **\(.level)**: \(.message) (code: \(.code))"' hadolint-results.json >> analysis-results.md 2>/dev/null
            DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + HADOLINT_COUNT))
          else
            echo "‚úÖ No Hadolint issues found" >> analysis-results.md
          fi
        else
          echo "‚úÖ No Hadolint issues found" >> analysis-results.md
        fi
        
        # Security scan summary
        echo "" >> analysis-results.md
        echo "### üîí Vulnerability Scan Summary" >> analysis-results.md
        if [ "${SBOM_REAL_VULN_COUNT:-0}" -gt 0 ]; then
          echo "‚ö†Ô∏è **$SBOM_REAL_VULN_COUNT vulnerabilities** detected:" >> analysis-results.md
          [ "${SBOM_CRITICAL_COUNT:-0}" -gt 0 ] && echo "- üö® Critical: $SBOM_CRITICAL_COUNT" >> analysis-results.md
          [ "${SBOM_HIGH_COUNT:-0}" -gt 0 ] && echo "- üî¥ High: $SBOM_HIGH_COUNT" >> analysis-results.md
          [ "${SBOM_MEDIUM_COUNT:-0}" -gt 0 ] && echo "- üü° Medium: $SBOM_MEDIUM_COUNT" >> analysis-results.md
          [ "${SBOM_LOW_COUNT:-0}" -gt 0 ] && echo "- üîµ Low: $SBOM_LOW_COUNT" >> analysis-results.md
        else
          echo "‚úÖ No vulnerabilities detected" >> analysis-results.md
        fi
        
        # Summary
        echo "" >> analysis-results.md
        echo "---" >> analysis-results.md
        echo "### Summary" >> analysis-results.md
        if [ "$DOCKERFILE_ISSUE_COUNT" -gt 0 ]; then
          echo "**Dockerfile issues:** $DOCKERFILE_ISSUE_COUNT" >> analysis-results.md
        else
          echo "‚úÖ **Excellent:** No Dockerfile configuration issues found" >> analysis-results.md
        fi
        
        echo "issue_count=$DOCKERFILE_ISSUE_COUNT" >> $GITHUB_OUTPUT
        echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
        echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
        echo "medium_count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT
        echo "low_count=$LOW_COUNT" >> $GITHUB_OUTPUT

    # ========== SECURITY RECOMMENDATIONS ==========
    - name: Generate security recommendations
      if: steps.build.outputs.build_success == 'true'
      run: |
        cat > security-recommendations.md << 'EOF'
# üõ°Ô∏è Security Recommendations

## General Recommendations

1. **Keep base image updated** - Regularly update to latest patch versions
2. **Use multi-stage builds** - Minimize final image size and attack surface
3. **Run as non-root** - Always use USER instruction
4. **Use scratch/distroless** - For Go binaries, consider minimal base images
5. **Pin versions** - Pin all package and tool versions

## Vulnerability Management

1. **Review CVEs** - Check if vulnerabilities are applicable to your use case
2. **Update packages** - Apply security patches promptly
3. **Use ignore files** - Document accepted risks in `.grype.yaml` and `.trivyignore`

## CI/CD Security

1. **Pin action versions** - Use SHA or version tags for GitHub Actions
2. **Scan on every PR** - Catch vulnerabilities before merge
3. **Set severity thresholds** - Fail builds on Critical/High vulnerabilities
EOF
        echo "‚úÖ Security recommendations generated"

    # ========== COMPREHENSIVE REPORT ==========
    - name: Generate comprehensive vulnerability report
      if: steps.build.outputs.build_success == 'true'
      env:
        SBOM_REAL_VULN_COUNT: ${{ steps.sbom_scan.outputs.sbom_real_vuln_count }}
        SBOM_CRITICAL_COUNT: ${{ steps.sbom_scan.outputs.sbom_critical_count }}
        SBOM_HIGH_COUNT: ${{ steps.sbom_scan.outputs.sbom_high_count }}
        SBOM_MEDIUM_COUNT: ${{ steps.sbom_scan.outputs.sbom_medium_count }}
        SBOM_LOW_COUNT: ${{ steps.sbom_scan.outputs.sbom_low_count }}
        TRIVY_TOTAL_COUNT: ${{ steps.trivy_scan.outputs.trivy_total_count }}
      run: |
        echo "# üõ°Ô∏è Comprehensive Security Report" > vulnerability-report.md
        echo "" >> vulnerability-report.md
        echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> vulnerability-report.md
        echo "**Image:** alpine-secure:latest" >> vulnerability-report.md
        echo "**Alpine Version:** ${{ steps.sbom_generation.outputs.alpine_version }}" >> vulnerability-report.md
        echo "" >> vulnerability-report.md

        echo "## üìä Vulnerability Summary" >> vulnerability-report.md
        echo "" >> vulnerability-report.md
        
        echo "### Grype SBOM Scan" >> vulnerability-report.md
        echo "- Total: ${SBOM_REAL_VULN_COUNT:-0}" >> vulnerability-report.md
        echo "- Critical: ${SBOM_CRITICAL_COUNT:-0}" >> vulnerability-report.md
        echo "- High: ${SBOM_HIGH_COUNT:-0}" >> vulnerability-report.md
        echo "- Medium: ${SBOM_MEDIUM_COUNT:-0}" >> vulnerability-report.md
        echo "- Low: ${SBOM_LOW_COUNT:-0}" >> vulnerability-report.md
        echo "" >> vulnerability-report.md
        
        echo "### Trivy Image Scan" >> vulnerability-report.md
        echo "- Total: ${TRIVY_TOTAL_COUNT:-0}" >> vulnerability-report.md
        echo "" >> vulnerability-report.md

        echo "‚úÖ Comprehensive report generated"

    # ========== UPLOAD ARTIFACTS ==========
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: alpine-security-reports-${{ github.sha }}
        path: |
          analysis-results.md
          security-recommendations.md
          vulnerability-report.md
          grype-detailed-report.md
          package-table.md
          docker-layers-detailed.md
          docker-layers.txt
          docker-inspect.json
          dive-analysis.json
          sbom-scan-all-severities.json
          trivy-results-all-severities.json
          trivy-report.txt
          sbom.cyclonedx.json
          sbom.spdx.json
          sbom.syft.json
          alpine-secure-image.tar.gz
          build-output.log
          hadolint-results.json
          .grype.yaml
          .trivyignore
        retention-days: 30

    # ========== CREATE ISSUE ==========
    - name: Create Security Issue
      uses: actions/github-script@v7
      if: always()
      env:
        ISSUE_COUNT: ${{ steps.analysis.outputs.issue_count }}
        CRITICAL_COUNT: ${{ steps.analysis.outputs.critical_count }}
        BUILD_SUCCESS: ${{ steps.build.outputs.build_success }}
      with:
        script: |
          const fs = require('fs');
          
          // Read reports
          const report = fs.existsSync('analysis-results.md') 
            ? fs.readFileSync('analysis-results.md', 'utf8')
            : '## Alpine Security Analysis\n\nResults not available.';
          
          const packageTable = fs.existsSync('package-table.md') 
            ? fs.readFileSync('package-table.md', 'utf8')
            : '';
          
          const issueCount = parseInt(process.env.ISSUE_COUNT) || 0;
          const criticalCount = parseInt(process.env.CRITICAL_COUNT) || 0;
          const buildSuccess = process.env.BUILD_SUCCESS;
          
          // Parse Grype results
          let vulnerabilityBreakdown = { Critical: 0, High: 0, Medium: 0, Low: 0, Unknown: 0 };
          let grypeVulnerabilities = [];
          
          try {
            if (fs.existsSync('sbom-scan-all-severities.json')) {
              const grypeData = JSON.parse(fs.readFileSync('sbom-scan-all-severities.json', 'utf8'));
              if (grypeData.matches && Array.isArray(grypeData.matches)) {
                grypeVulnerabilities = grypeData.matches;
                grypeVulnerabilities.forEach(match => {
                  const severity = match.vulnerability?.severity || 'Unknown';
                  if (vulnerabilityBreakdown[severity] !== undefined) {
                    vulnerabilityBreakdown[severity]++;
                  } else {
                    vulnerabilityBreakdown.Unknown++;
                  }
                });
              }
            }
          } catch (error) {
            console.log('Error parsing Grype results:', error.message);
          }
          
          const realVulnerabilities = Object.values(vulnerabilityBreakdown).reduce((a, b) => a + b, 0);
          
          // Determine title and labels
          let title;
          let labels = ['security', 'docker', 'alpine', 'automated'];
          
          if (buildSuccess === 'false') {
            title = `üö® Alpine Docker Build Failed`;
            labels.push('build-failed', 'critical');
          } else if (vulnerabilityBreakdown.Critical > 0) {
            title = `üö® CRITICAL: ${vulnerabilityBreakdown.Critical} critical vulnerabilities`;
            labels.push('critical');
          } else if (vulnerabilityBreakdown.High > 0) {
            title = `üî¥ HIGH: ${vulnerabilityBreakdown.High} high severity vulnerabilities`;
            labels.push('high');
          } else if (realVulnerabilities > 0) {
            title = `‚ö†Ô∏è Security: ${realVulnerabilities} vulnerabilities found`;
            labels.push('security-vulnerabilities');
          } else if (issueCount > 0) {
            title = `üìã Alpine Scan: ${issueCount} configuration issues`;
            labels.push('needs-attention');
          } else {
            title = `‚úÖ Alpine Security Scan: All checks passed`;
            labels.push('passed');
          }
          
          // Build vulnerability report section
          let vulnerabilityReport = `## üõ°Ô∏è Vulnerability Report\n\n`;
          
          if (realVulnerabilities > 0) {
            vulnerabilityReport += `### Summary\n`;
            vulnerabilityReport += `- Total: ${realVulnerabilities}\n`;
            if (vulnerabilityBreakdown.Critical > 0) vulnerabilityReport += `- üö® Critical: ${vulnerabilityBreakdown.Critical}\n`;
            if (vulnerabilityBreakdown.High > 0) vulnerabilityReport += `- üî¥ High: ${vulnerabilityBreakdown.High}\n`;
            if (vulnerabilityBreakdown.Medium > 0) vulnerabilityReport += `- üü° Medium: ${vulnerabilityBreakdown.Medium}\n`;
            if (vulnerabilityBreakdown.Low > 0) vulnerabilityReport += `- üîµ Low: ${vulnerabilityBreakdown.Low}\n`;
            vulnerabilityReport += `\n`;
            
            // Show top vulnerabilities
            const topVulns = grypeVulnerabilities.slice(0, 10);
            if (topVulns.length > 0) {
              vulnerabilityReport += `### Top Vulnerabilities\n\n`;
              topVulns.forEach((match, index) => {
                const vuln = match.vulnerability;
                const artifact = match.artifact;
                const severityEmoji = {
                  'Critical': 'üö®', 'High': 'üî¥', 'Medium': 'üü°', 'Low': 'üîµ', 'Unknown': '‚ö™'
                }[vuln.severity] || '‚ö™';
                
                vulnerabilityReport += `${index + 1}. **${vuln.id}** ${severityEmoji} ${vuln.severity} - \`${artifact.name}@${artifact.version}\`\n`;
              });
              if (grypeVulnerabilities.length > 10) {
                vulnerabilityReport += `\n*...and ${grypeVulnerabilities.length - 10} more in artifacts*\n`;
              }
            }
          } else {
            vulnerabilityReport += `### ‚úÖ No Vulnerabilities Found\n\nSecurity scanners did not find any vulnerabilities.\n`;
          }
          
          // Build full issue body
          const body = `${report}\n\n${vulnerabilityReport}\n\n${packageTable}\n\n---\n*Generated by [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;
          
          // Create issue
          const { data: newIssue } = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: labels
          });
          
          console.log(`‚úÖ Created issue #${newIssue.number}`);

  # ========== SECURITY GATES ==========
  security-gates:
    runs-on: ubuntu-latest
    needs: security-scan
    if: always()

    steps:
      - name: Check security gates
        env:
          CRITICAL_COUNT: ${{ needs.security-scan.outputs.critical_count }}
          BUILD_SUCCESS: ${{ needs.security-scan.outputs.build_success }}
          SBOM_REAL_VULN_COUNT: ${{ needs.security-scan.outputs.sbom_real_vuln_count }}
        run: |
          echo "üîí Checking security gates..."
          
          if [ "$BUILD_SUCCESS" = "false" ]; then
            echo "‚ùå Docker build failed"
            exit 1
          fi
          
          if [ "${CRITICAL_COUNT:-0}" -gt 0 ]; then
            echo "‚ùå Critical Dockerfile issues found: $CRITICAL_COUNT"
            exit 1
          fi
          
          # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: fail –Ω–∞ Critical CVE
          # if [ "${SBOM_CRITICAL_COUNT:-0}" -gt 0 ]; then
          #   echo "‚ùå Critical vulnerabilities found"
          #   exit 1
          # fi
          
          echo "‚úÖ All security gates passed"
          echo "üìä Vulnerabilities found: ${SBOM_REAL_VULN_COUNT:-0} (non-blocking)"
