name: Go CI/CD

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Initialize Go module
      run: |
        # Создаем go.mod если его нет (простейшая версия)
        if [ ! -f go.mod ]; then
          echo "module mitre-mitigates" > go.mod
          echo "go 1.21" >> go.mod
        fi
        cat go.mod
    
    - name: Build binary
      run: |
        # Собираем основной бинарник
        go build -o mitremit mitre-mitigates.go
        echo "✅ Build successful"
        ls -lh mitremit
    
    - name: Test basic functionality
      run: |
        # Тест 1: Проверка help
        echo "Testing help command..."
        if ./mitremit -h 2>&1 | grep -i "usage"; then
          echo "✅ Help command works"
        else
          echo "❌ Help command failed"
          exit 1
        fi
        
        # Тест 2: Проверка минимальной функциональности
        echo "Testing basic query..."
        # Запускаем с таймаутом, так как будет скачивать MITRE бандл
        timeout 30s ./mitremit -mitigation M1037 2>&1 | head -5 || true
    
    - name: Cross-compile for different platforms
      run: |
        mkdir -p dist
        
        echo "Building for Linux (amd64)..."
        GOOS=linux GOARCH=amd64 go build -o dist/mitremit-linux-amd64 mitre-mitigates.go
        
        echo "Building for macOS (amd64)..."
        GOOS=darwin GOARCH=amd64 go build -o dist/mitremit-darwin-amd64 mitre-mitigates.go
        
        echo "Building for Windows (amd64)..."
        GOOS=windows GOARCH=amd64 go build -o dist/mitremit-windows-amd64.exe mitre-mitigates.go
        
        echo "Build artifacts:"
        ls -lh dist/
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mitre-mitigates-binaries
        path: |
          mitremit
          dist/
        retention-days: 7
